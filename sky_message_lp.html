<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sky Message - 恋の糸電話</title>
    <!-- Tailwind CSS CDNをロード -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Interフォントを使用 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* 背景: 夕焼けと青空が混じり、流星が描かれたロマンチックな空をシミュレート */
            background: linear-gradient(135deg, #FF7E5F 0%, #FEB47B 40%, #00C6FF 100%);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
        }

        /* 流星のアニメーション */
        .meteor {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: #ffffff;
            opacity: 0;
            animation: shooting-star 5s linear infinite;
        }
        .meteor:nth-child(1) { top: 5%; left: 10%; animation-delay: 1s; }
        .meteor:nth-child(2) { top: 15%; right: 5%; animation-delay: 4s; }
        .meteor:nth-child(3) { bottom: 20%; left: 30%; animation-delay: 7s; }

        @keyframes shooting-star {
            0% { transform: translate(0, 0) rotate(45deg); opacity: 0; }
            10% { opacity: 1; }
            80% { transform: translate(400px, 400px) rotate(45deg); opacity: 0; }
            100% { transform: translate(400px, 400px) rotate(45deg); opacity: 0; }
        }

        /* 透過フォームのスタイル */
        .glass-morphism {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        /* テキスト装飾のクラス定義 */
        .text-gold { color: #FFD700; }
        .text-orange { color: #FFA500; }
        .text-lightblue { color: #87CEFA; }
        .deco-shadow { text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); }
        .deco-glow { text-shadow: 0 0 10px #ffffff, 0 0 20px currentColor; }
        .deco-blur { filter: blur(0.8px); }
        
        /* 送信アニメーションのスタイル */
        #sent-animation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: background 1s ease-out;
        }
        #sent-message {
            font-size: 3rem;
            font-weight: 700;
            color: #fff;
            opacity: 0;
            transition: opacity 2s ease-in-out;
            text-shadow: 0 0 15px #fff;
        }
        .light-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff, 0 0 20px #FFD700;
            opacity: 0;
            animation: fly-to-sky 3s ease-in-out forwards;
        }
        @keyframes fly-to-sky {
            0% { opacity: 1; transform: translate(var(--x-start), var(--y-start)) scale(1); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: translate(0, -50vh) scale(0.1); } /* 画面上部中央へ吸い込まれる */
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- 流星の要素 -->
    <div class="meteor"></div>
    <div class="meteor"></div>
    <div class="meteor"></div>

    <!-- メインコンテンツ -->
    <div id="main-content" class="w-full max-w-xl mx-auto p-4 md:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-5xl font-extrabold mb-2" style="text-shadow: 0 0 10px #fff;">Sky Message</h1>
            <h2 class="text-xl font-light italic opacity-90">遠くにいる大切な人と繋がる「恋の糸電話」</h2>
            <p class="text-sm mt-2 opacity-75">コンパスで2人の方角が重なったとき、メッセージが空を流れてあなたの思いを大切な人に届けます。</p>
        </header>

        <!-- 入力フォーム (透過デザイン) -->
        <div id="input-form-container" class="glass-morphism p-6 md:p-8 rounded-xl shadow-2xl">
            <form id="sky-message-form" class="space-y-6">
                
                <!-- 送り手の名前 -->
                <div>
                    <label for="sender-name" class="block mb-2 font-medium">送り手の名前（From）</label>
                    <input type="text" id="sender-name" placeholder="あなたの名前" required maxlength="20"
                           class="w-full p-3 rounded-lg bg-white/10 border border-white/30 focus:outline-none focus:ring-2 focus:ring-sky-400">
                </div>
                
                <!-- メッセージ入力 -->
                <div>
                    <label for="message-textarea" class="block mb-2 font-medium">届けたい言葉、空へ (150文字まで)</label>
                    <textarea id="message-textarea" maxlength="150" placeholder="例：元気？星空が見える方角にいるよ。" required
                              class="w-full p-3 rounded-lg bg-white/10 border border-white/30 h-32 resize-none focus:outline-none focus:ring-2 focus:ring-sky-400"></textarea>
                    <p id="char-count" class="text-right text-sm mt-1 opacity-70">残り 150 文字</p>
                </div>
                
                <!-- テキスト装飾設定 -->
                <div class="space-y-4 pt-4 border-t border-white/20">
                    <h3 class="text-lg font-semibold">メッセージのテーマ設定</h3>
                    
                    <!-- テキストの色 -->
                    <div>
                        <span class="block mb-2 text-sm font-medium">テキストの色</span>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="text-color" value="gold" class="form-radio text-yellow-500" checked>
                                <span class="text-gold font-bold">ゴールド</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="text-color" value="orange" class="form-radio text-orange-500">
                                <span class="text-orange font-bold">オレンジ</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="text-color" value="lightblue" class="form-radio text-blue-300">
                                <span class="text-lightblue font-bold">水色</span>
                            </label>
                        </div>
                    </div>

                    <!-- テキストの装飾 -->
                    <div>
                        <span class="block mb-2 text-sm font-medium">テキストの装飾</span>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="text-decoration" value="shadow" class="form-checkbox text-sky-400" checked>
                                <span>影</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="text-decoration" value="glow" class="form-checkbox text-sky-400">
                                <span>発光</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="text-decoration" value="blur" class="form-checkbox text-sky-400">
                                <span>ぼかし</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 文字確認ボタンとプレビュー -->
                    <button type="button" id="check-text-button" 
                            class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition duration-200 shadow-md">
                        文字確認ボタン
                    </button>
                    <div id="text-preview" class="text-2xl text-center p-4 mt-4 rounded-lg bg-black/30 transition-all duration-300 min-h-[50px] flex items-center justify-center font-extrabold">
                        プレビューテキスト
                    </div>
                </div>

                <!-- 位置情報取得設定 -->
                <div class="space-y-4 pt-4 border-t border-white/20">
                    <h3 class="text-lg font-semibold">位置情報の設定</h3>
                    
                    <div>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="location-type" value="current" class="form-radio text-sky-400" checked>
                            <span>① 送信者の現在の位置情報</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="location-type" value="manual" class="form-radio text-sky-400">
                            <span>② 別の位置情報（Google Mapで指定）</span>
                        </label>
                        <!-- Google Map指定UIはここではダミー表示 -->
                        <div id="map-selector" class="mt-2 p-3 bg-white/10 rounded-lg text-sm text-center" style="display:none;">
                            [Google Mapで位置を指定するUIのプレースホルダー]
                        </div>
                    </div>
                    
                    <!-- 位置情報取得ボタン -->
                    <button type="button" id="get-location-button" 
                            class="w-full py-3 bg-pink-500 hover:bg-pink-600 rounded-lg transition duration-200 shadow-lg font-bold">
                        （位置情報を取得）
                    </button>
                    <p id="location-status" class="text-center text-sm mt-2">位置情報：未取得</p>
                </div>

                <!-- 送信ボタン -->
                <button type="submit" id="send-button" disabled
                        class="w-full py-4 bg-yellow-500 text-gray-900 rounded-lg transition duration-200 shadow-xl font-extrabold text-xl disabled:opacity-50">
                    送信ボタン
                </button>
            </form>
        </div>
    </div>
    
    <!-- 送信アニメーションオーバーレイ -->
    <div id="sent-animation-overlay" style="display:none;">
        <!-- 光の粒はJSで生成 -->
        <p id="sent-message">Sent to the Sky</p>
    </div>

    <!-- カスタムモーダル（メッセージボックス） -->
    <div id="custom-modal" class="fixed inset-0 bg-black/70 z-[200] flex items-center justify-center p-4" style="display:none;">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-gray-900 space-y-4">
            <h3 id="modal-title" class="text-xl font-bold">お知らせ</h3>
            <p id="modal-content"></p>
            <button id="modal-close-button" class="w-full py-2 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition">閉じる</button>
        </div>
    </div>


    <script type="module">
        // Firebaseのインポート (FirestoreとAuth)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // グローバル変数の定義（Canvas環境から提供されることを想定）
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let senderLat = null;
        let senderLon = null;
        let userId = null;

        // UI要素の取得
        const form = document.getElementById('sky-message-form');
        const messageTextarea = document.getElementById('message-textarea');
        const charCount = document.getElementById('char-count');
        const getLocationButton = document.getElementById('get-location-button');
        const sendButton = document.getElementById('send-button');
        const locationStatus = document.getElementById('location-status');
        const textPreview = document.getElementById('text-preview');
        const mapSelector = document.getElementById('map-selector');
        const sentOverlay = document.getElementById('sent-animation-overlay');
        const sentMessage = document.getElementById('sent-message');

        // カスタムモーダル表示関数 (alert()の代わり)
        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            document.getElementById('custom-modal').style.display = 'flex';
        }
        document.getElementById('modal-close-button').addEventListener('click', () => {
            document.getElementById('custom-modal').style.display = 'none';
        });

        // Firebase初期化と認証
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase Configuration is missing.");
                showModal("エラー", "Firebaseの設定情報が不足しています。アプリの動作にはデータベースが必要です。");
                return;
            }
            
            // ログレベル設定
            setLogLevel('debug');

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 認証
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                console.log("Firebase initialized. User ID:", userId);
                sendButton.disabled = false; // 認証完了後に送信ボタンを有効化

            } catch (error) {
                console.error("Firebase Initialization/Auth Error:", error);
                showModal("認証エラー", "Firebaseへの接続または認証に失敗しました。");
            }
        }
        
        // メッセージプレビューの更新関数
        function updatePreview() {
            const message = messageTextarea.value.trim() || textPreview.dataset.defaultText;
            const color = document.querySelector('input[name="text-color"]:checked').value;
            const decorations = Array.from(document.querySelectorAll('input[name="text-decoration"]:checked')).map(el => el.value);

            // クラスをリセット
            textPreview.className = 'text-2xl text-center p-4 mt-4 rounded-lg bg-black/30 transition-all duration-300 min-h-[50px] flex items-center justify-center font-extrabold';

            // 色クラスを設定
            textPreview.classList.add(`text-${color}`);

            // 装飾クラスを設定
            if (decorations.includes('shadow')) textPreview.classList.add('deco-shadow');
            if (decorations.includes('glow')) textPreview.classList.add('deco-glow');
            if (decorations.includes('blur')) textPreview.classList.add('deco-blur');
            
            // テキストを設定
            textPreview.textContent = message;
        }

        // --- イベントリスナーの設定 ---
        
        // 1. 文字数制限とプレビューの初期設定
        textPreview.dataset.defaultText = 'プレビューテキスト';
        messageTextarea.addEventListener('input', () => {
            const currentLength = messageTextarea.value.length;
            charCount.textContent = `残り ${150 - currentLength} 文字`;
            updatePreview(); // 入力に応じてプレビューを更新
        });
        
        // 2. 色と装飾のラジオ/チェックボックス変更時にもプレビューを更新
        document.querySelectorAll('input[name="text-color"], input[name="text-decoration"]').forEach(input => {
            input.addEventListener('change', updatePreview);
        });
        
        // 3. 文字確認ボタン
        document.getElementById('check-text-button').addEventListener('click', () => {
            updatePreview();
            // 特にフィードバックは不要だが、デザイン要件にあるためボタンとして機能させる
        });

        // 4. 位置情報タイプの選択
        document.querySelectorAll('input[name="location-type"]').forEach(input => {
            input.addEventListener('change', (e) => {
                if (e.target.value === 'manual') {
                    mapSelector.style.display = 'block';
                    locationStatus.textContent = '位置情報：手動設定待ち';
                    // 手動選択時は座標をクリア
                    senderLat = null;
                    senderLon = null;
                } else {
                    mapSelector.style.display = 'none';
                    locationStatus.textContent = '位置情報：未取得';
                    // タイプが戻った時に再度取得が必要
                    senderLat = null;
                    senderLon = null;
                }
                // 送信ボタンの状態を更新
                sendButton.disabled = !userId || !senderLat;
            });
        });

        // 5. 位置情報取得機能の実装
        getLocationButton.addEventListener('click', () => {
            if (document.querySelector('input[name="location-type"]:checked').value === 'current') {
                locationStatus.textContent = '位置情報：取得中...';
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            senderLat = position.coords.latitude;
                            senderLon = position.coords.longitude;
                            locationStatus.textContent = `位置情報：取得済み (${senderLat.toFixed(4)}, ${senderLon.toFixed(4)})`;
                            sendButton.disabled = !userId; // 認証済みなら送信可能に
                        },
                        (error) => {
                            if (error.code === error.PERMISSION_DENIED) {
                                // GPSアクセス拒否時のカスタムモーダル表示
                                showModal("位置情報アクセスが必要です", "Sky Messageは、あなたの想いを届けるために現在の位置情報（GPSアクセス）が必要です。ブラウザの設定からアクセスを許可してください。");
                            } else {
                                showModal("エラー", "位置情報の取得に失敗しました。GPSが有効になっているか確認してください。");
                            }
                            locationStatus.textContent = '位置情報：取得失敗';
                            senderLat = null;
                            senderLon = null;
                            sendButton.disabled = true;
                        }
                    );
                } else {
                    showModal("エラー", "お使いのブラウザは位置情報APIに対応していません。");
                    sendButton.disabled = true;
                }
            } else {
                // 手動設定（Google Map指定の代わり）
                // 実際にはマップUIで座標を取得するが、ここでは仮の座標を設定
                senderLat = 35.6895; // 東京
                senderLon = 139.6917;
                locationStatus.textContent = `位置情報：手動指定済み (東京: ${senderLat}, ${senderLon})`;
                sendButton.disabled = !userId;
            }
        });

        // 6. 送信処理の実装
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db || !userId) {
                showModal("エラー", "アプリが初期化されていません。しばらく待ってから再度お試しください。");
                return;
            }

            if (!senderLat || !senderLon) {
                showModal("エラー", "位置情報を取得または手動で設定してから送信してください。");
                return;
            }
            
            if (messageTextarea.value.trim().length === 0) {
                showModal("エラー", "メッセージを入力してください。");
                return;
            }

            // A. 入力フォームの情報取得
            const message = messageTextarea.value.trim();
            const senderName = document.getElementById('sender-name').value.trim() || '名無し';
            const theme = document.querySelector('input[name="text-color"]:checked').value;
            const decorations = Array.from(document.querySelectorAll('input[name="text-decoration"]:checked')).map(el => el.value);

            // UIを送信アニメーションに切り替え
            document.getElementById('input-form-container').style.display = 'none';
            sentOverlay.style.display = 'flex';
            
            // B. Firestoreへの保存（URLリンク情報に生成/保存）
            const messageData = {
                message: message,
                sender: senderName,
                // 位置情報は公開データとして保存（受信者全員がアクセスできる）
                senderLat: senderLat, 
                senderLon: senderLon,
                theme: theme,
                decorations: decorations,
                timestamp: Date.now(),
                // 送信者のユーザーIDをメタデータとして保存
                sentByUserId: userId 
            };
            
            try {
                // Publicコレクションに保存: /artifacts/{appId}/public/data/messages
                const collectionPath = `artifacts/${appId}/public/data/messages`;
                const docRef = await addDoc(collection(db, collectionPath), messageData);
                const uniqueMessageID = docRef.id;
                
                // 受信者に送るURLリンク情報をシミュレート (後でアプリURLに置き換える)
                const urlLinkInfo = `${window.location.origin}/sky_message_app.html?id=${uniqueMessageID}`;
                
                console.log("Message Sent. Document ID:", uniqueMessageID);
                console.log("Recipient URL:", urlLinkInfo);
                
                // C. 光の粒アニメーション
                const particleCount = 20;
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.classList.add('light-particle');
                    
                    // フォームエリアからランダムに発生させる
                    const xStart = (Math.random() * sentOverlay.offsetWidth) - (sentOverlay.offsetWidth / 2);
                    const yStart = (Math.random() * sentOverlay.offsetHeight) - (sentOverlay.offsetHeight / 2);
                    
                    particle.style.setProperty('--x-start', `${xStart}px`);
                    particle.style.setProperty('--y-start', `${yStart}px`);
                    particle.style.animationDelay = `${Math.random() * 0.5}s`;
                    
                    sentOverlay.appendChild(particle);
                    
                    // アニメーション完了後に要素を削除
                    setTimeout(() => particle.remove(), 4000);
                }

                // D. 最後に淡く “Sent to the Sky” と文字表示
                setTimeout(() => {
                    sentMessage.style.opacity = '1';
                }, 1000); 

                // 最終的なメッセージ表示（ユーザーへのフィードバック）
                setTimeout(() => {
                    sentMessage.textContent = "Sent to the Sky (URLをコピーして受信者に送ってください)";
                    sentMessage.style.fontSize = '1.5rem';
                    
                    // 受信URLの表示とコピーボタン
                    const urlDisplay = document.createElement('div');
                    urlDisplay.className = 'mt-8 p-4 bg-white/20 rounded-lg max-w-lg mx-auto break-all text-sm';
                    urlDisplay.textContent = urlLinkInfo;
                    sentOverlay.appendChild(urlDisplay);
                    
                    const copyButton = document.createElement('button');
                    copyButton.textContent = 'URLをコピー';
                    copyButton.className = 'mt-4 py-2 px-4 bg-green-500 hover:bg-green-600 rounded-lg transition font-medium';
                    copyButton.onclick = () => {
                         // document.execCommand('copy')を使用
                        const tempInput = document.createElement('textarea');
                        tempInput.value = urlLinkInfo;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        copyButton.textContent = 'コピー完了！';
                        setTimeout(() => copyButton.textContent = 'URLをコピー', 1500);
                    };
                    sentOverlay.appendChild(copyButton);

                }, 4000);


            } catch (error) {
                console.error("Firestoreへの書き込みエラー:", error);
                showModal("送信エラー", "メッセージの送信に失敗しました。ネットワーク接続を確認してください。");
                
                // フォームを戻す
                document.getElementById('input-form-container').style.display = 'block';
                sentOverlay.style.display = 'none';
            }
            
        });
        
        // ページロード時にFirebaseの初期化を開始
        window.onload = initializeFirebase;
        updatePreview(); // 初回プレビュー表示

    </script>
</body>
</html>